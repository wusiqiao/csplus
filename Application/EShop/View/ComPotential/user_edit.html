<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style” content=black" />
    <title>{$title}</title>
    <link href="{$Think.const.CSS_URL}mui/mui.css" rel="stylesheet" />
    <link href="{$Think.const.CSS_URL}reset.css" rel="stylesheet" />
    <link href="{$Think.const.CSS_URL}common.css" rel="stylesheet" />
    <link href="{$Think.const.CSS_URL}style.css?v=4" rel="stylesheet" />
    <link href="/{$Think.APP_PATH}Public/mui/css/mui.poppicker.css" rel="stylesheet" />
    <link href="/{$Think.APP_PATH}Public//mui/css/mui.picker.css" rel="stylesheet" />
</head>
<style>
    textarea {
        margin-top: .1rem;
        margin-bottom: .1rem;
    }
    .delete-div {
        flex: .2;
        line-height: 1rem;
    }
    .delete-div span{
        border: 1px solid red;
        padding: .05rem;
        border-radius: .05rem;
        color: red;
    }
    .grey{
        color:#808080;
    }
    .relieve{
        color:#4891FE;
        text-align: center;
    }
    .drop::after{
        display: inline-block;
        content: '';
        width: 0;
        height:0;
        border: 5px solid transparent;
        border-top:5px solid #A5A4A4;
        border-bottom: none;
    }
     .lable{
        display: inline-block;
        height: 30px;
        line-height: 30px;
        border: 1px solid #ccc;
        border-radius: 2px;
        padding: 0 5px;
        color: #A9A9A9;
    }
    .tag-checkbox input[type='checkbox'] {
        content: '';
        width: 30px;
        height: 30px;
        background-image: url(/{$Think.MODULE_PATH}Public/images/work/none.png);
        background-repeat: no-repeat;
        background-size: .33rem .33rem;
        background-position: center;
        outline: none;
        background-color: transparent;
        -webkit-appearance: none;
    }
    .tag-checkbox input[type='checkbox']:checked {
        content: '';
        width: 30px;
        height: 30px;
        background-image: url(/{$Think.MODULE_PATH}Public/images/work/ok.png);
        background-repeat: no-repeat;
        background-size: .33rem .33rem;
        background-position: center;
        outline: none;
        background-color: transparent;
        -webkit-appearance: none;
    }
    .basic-info .info-con {
        justify-content: flex-end;
    }
</style>

<body style="margin-top: .85rem;">
    <include file="Index:header" />
    <div class="info-line template-1" style="display:none">
        <div class="info-title">{%title%}<i></i></div>
        <input type="text" data-title="{%title%}" value="" />
        <div class="delete-div">
            <span>删除</span>
        </div>
    </div>
    <div class="my-wrap-top my-wrap-top-img user-edit-top">
        <!--<a href="__MODULE__/User/user_header.html">-->
        <a>
            <if condition="$result.head_pic neq ''">
                <img src="{$result.head_pic}?v={$versions}" alt="" />
                <else/>
                <img src="/{$Think.MODULE_PATH}Public/images/icon/user_pic_none.jpg" alt="" />
            </if>
        </a>
        <div class="line50 font30 white">{$result.name}</div>
        <div class="line50 font30 white">最近访问时间：{$result.last_time}</div>
    </div>
    <section class="custom-info-wrap common-wrap bg-none">
        <div style="display:flex">
            <div class="my-wrap-center" style="width:47%;margin-right:6%">
                <div class="nav-default">
                    <if condition="$permissions['_IS_Manager_'] eq 1 or ($menuList['WxBranchTemplate']['menu_actions']['detail'] eq 1 and $menuList['WxBranchTemplate']['allow'] eq 1)">
                        <a href="/WxBranchTemplate/index/user/{$result.id}.html">
                            <img class="msg-template" src="/Application/EShop/Public/images/my/msg-template.png" alt="">
                            <span>发送模板通知</span>
                        </a>
                        <else />
                        <a href="javascript:;" onclick="mui.alert('无此功能操作权限')">
                            <img class="msg-template" src="/Application/EShop/Public/images/my/msg-template.png" alt="">
                            <span>发送模板通知</span>
                        </a>
                    </if>
                </div>
            </div>
            <div class="my-wrap-center" style="width:47%">
                <div class="nav-default">
                    <a href="javascript:;" data-mobile="{$result.mobile}" onclick="toTelephone(this);">
                        <img class="user-tel" src="/Application/EShop/Public/images/my/user-tel.png" alt="">
                        <span>拨打电话</span>
                    </a>
                </div>
            </div>
        </div>
        <form onsubmit="return false;" id="customerForm">
            <input type="hidden" id="unbindCom" value="" name="unbindCom">
            <input type="hidden" id="id" value="{$result.id}" name="id">
            <input type="hidden" id="branch_id" value="{$result.branch_id}" name="branch_id">
            <div class="basic-info mb20">
                <div class="title">用户信息</div>
                <!--                <div class="info-line pr grey">
                    <div class="info-title">昵称<i></i></div>
                    <input type="text" value="{$result.name}" readonly />
                </div> -->
                <div class="info-line pr">
                    <div class="info-title">备注<i></i></div>
                    <input type="text" name="comments" value="{$result.comments}" placeholder="请输入备注信息" />
                </div>
                <div class="info-line grey">
                    <div class="info-title">绑定手机<i></i></div>
                    <div class="info-con">
                        <eq name="result.mobile" value="" class="grey">
                            <p class="grey" style="width:60%;text-align: right;padding-right: 0.2rem;">未绑定 </p>
                            <eq name="result.is_follow" value="1" class="grey">
                                <div style="width:40%;color:#4891FE;" data-companyid="{$vo.id}" data-companyname="{$vo.name}" onclick="notifyUser()">邀请绑定手机</div>
                            </eq>
                            <else />
                            <p class="grey">{$result.mobile}</p>
                        </eq>
                    </div>
                </div>
                <div class="info-line grey">
                    <div class="info-title">用户类型</div>
                    <div class="info-con">
                        <p class="grey">{$result.user_type_value}</p>
                    </div>
                </div>
                <div class="info-line grey">
                    <div class="info-title">来源渠道</div>
                    <div class="info-con">
                        <p class="grey">{$result.subscribe_scene_value}</p>
                    </div>
                </div>
                <div class="info-line">
                    <div class="info-title">关注时间<i></i></div>
                    <div class="info-con">
                        <p class="grey">
                            <eq name="result.is_follow" value="1">
                                {$result.followed_at}
                                <else />
                                未关注
                            </eq>
                        </p>
                    </div>
                </div>
                
                <div class="info-line">
                    <div class="info-title">客户标签<i></i></div>
                    <div class="info-con tags-view tags-item" id="customerTag">
                        <template v-for="(item,index) in tag_list" >
                            <span v-if="index < 3" class="lable" style="margin-right:5px;">{{item.name}}</span>                                
                        </template>
                        <template v-if="tag_list.length == 0">
                            <p class="grey" id="tag-none" style="margin-right:10px">暂无标签</p>
                        </template>
                        <span id="add-tag" onclick="setTags()" class="drop"></span>
                        <!-- </div> -->
                        <!--<input name="delTags" type="hidden" id="delTags">-->
                        <!--<span class="tag-btn" id="add-tag">+</span>-->
                        <!--     <a id="add-tag" class="mui-icon mui-icon-plus" style="padding-left: 10px ;color: #0b95ff;float: right;font-size: 25px"></a>
                     -->
                    </div>
                    <div class="tags-div" style="display: none">
                        <volist name="result.tag" id="vo">
                            <input name="tags[]" value="{$vo.id}" />
                        </volist>
                    </div>
                </div>
                <!--                     <div class="info-line">
                        <div class="info-title">绑定时间<i></i></div>
                        <div class="info-con">
                            <p class="grey">
                                <eq name="result.binded_at" value="">
                                    未绑定
                                    <else/>
                                    {$result.binded_at}
                                </eq>
                            </p>
                        </div>
                    </div> -->
                <!-- <eq name="result.mobile" value=""> -->
                <!-- </eq> -->
            </div>
            <!--            <div class="basic-info mb20">
                <div class="title">用户设置</div>

                <div class="info-line grey">
                    <div class="info-title">用户类型<i></i></div>
                    <div class="info-con">
                    <if condition="$result.user_type eq $Think.const.USER_TYPE_COMPANY_MANAGER ">员工</if>
                    <if condition="$result.user_type eq $Think.const.USER_TYPE_CUSTOMER ">成交客户</if>
                    <if condition="$result.user_type eq $Think.const.USER_TYPE_PROSPECTIVE ">意向客户</if>
                    </div>
                </div>
            </div>

            <div class="basic-info mb20">
                <div class="title">分组标签</div>
                <div class="info-line" style="align-items: center;">
                    <div class="info-title">所在分组<i></i></div>
                    <div class="ptb15 pr25 flex-1">
                        <div class="company-selected">
                            <div id="group_name" style="color: #0B0000">
                                <eq name="result.group.value" value="">
                                    <p style="color: grey">未分组</p>
                                    <else/>
                                    {$result.group.value}
                                </eq></div>
                            <div onclick="groupList(this)" class="select-icon1"></div>
                            <input  name="group_id" type="hidden" value="{$result.group_id}" id="group_id"/>
                        </div>
                    </div>
                    <div id="new-group-btn" class=" " style="color: #4591fe;padding-right: 10px">添加新分组</div>
                </div>

                 -->
            </div>
            <!-- <div class="basic-info mb20"> -->
                <!-- <div class="title">联系信息</div>
                <div class="info-line">
                    <div class="info-title">联系人<i></i></div>
                    <input type="text" value="{$result.contacts}" name="contacts" placeholder="请输入联系人" />
                </div>
                <div class="info-line">
                    <div class="info-title">手机<i></i></div>
                    <input type="number" value="{$result.telephone}" name="telephone" placeholder="请输入手机" />
                </div> -->
                <!--                <div class="info-line">
                    <div class="info-title">传真<i></i></div>
                    <input type="tel" name="fax_number" value="{$result.fax_number}" placeholder="请输入传真号码"/>
                </div> -->
                <!-- <div class="info-line">
                    <div class="info-title"><span class="">QQ</span><i></i></div>
                    <input type="number" name="qq" value="{$result.qq}" placeholder="请输入QQ号" />
                </div>
                <div class="info-line">
                    <div class="info-title"><span class="">邮箱</span><i></i></div>
                    <input type="text" name="email" value="{$result.email}" placeholder="请输入邮箱" />
                </div>
                <div class="info-line" style="position: relative;box-shadow: none;">
                    <div class="info-title">联系地址<i></i></div>
                    <div class="area-chose" style="color: #4891FE;" id='showCityPicker'>
                        <div class="province-city" id="showCity" style="margin: .3rem .3rem .3rem .1rem;">
                            {$result.region}
                        </div>
                        <input type="hidden" value="{$result.province}" name="province" id="province" />
                        <input type="hidden" value="{$result.city}" name="city" id="city" />
                        <input type="hidden" value="{$result.district}" name="district" id="district" />
                        <span class="mui-icon mui-icon-arrowright" style="position: absolute; right:4%;top:35%;"></span>
                    </div>
                </div>
                <div class="info-line">
                    <div class="info-title"><i></i></div>
                    <textarea rows="" cols="" name="address" placeholder="详细地址">{$result.address}</textarea>
                </div> -->
                <!--                 <div id="informations">
                    <volist name="information" id="vo">
                        <div class="info-line">
                            <div class="info-title">{$vo.title}<i></i></div>
                            <input type="text"  style="width: 80%" data-id="{$vo.id}" data-title="{$vo.title}" value="{$vo.value}"/>
                            <div class="delete-div">
                                <span>删除</span>
                            </div>
                        </div>
                    </volist>
                </div>
                <input type="hidden" name="delInfo" id="delInfo" value="">
                <div class="info-line">
                    <div class="customize blue-4591fe">+新增自定义类型</div>
                </div> -->
            <!-- </div> -->
            <eq name="result.is_follow" value="1" class="grey">
                <div class="basic-info mb20" id="companyData-all" v-if="companyList.length > 0">
                    <div class="title">绑定公司
<!--                         <div class="relieve" data-companyid="{$vo.id}"
                             data-companyname="{$vo.name}" onclick="unbindCom(this)" style="color: red">解除匹配</div> -->
                    </div>
                    <template v-for="(vo,key) in companyList">
                        <div :id="'company-'+vo.id">
                            <div class="info-line grey">
                                <div class="info-title">公司{{key+1}}<i></i></div>
                                <div style="width:60%;text-align: right;padding-right:0.4rem;">
                                    <span class="relieve">{{vo.name}}</span>
                                    <!-- <input type="text" value="" readonly style="width:65%" /> -->
                                    <img class="arrow" :data-companyid="vo.id" onclick="showCompanyData(this)" flag="1" style="height:0.13333333rem;margin-top:0.5rem" src="{$Think.const.IMG_URL}/Organization/x9.png" alt="">
                                </div>
<!--                                 <div class="relieve" style="width:10%" :data-companyid="vo.id" :data-companyname="vo.name" onclick="unbindCom(this)">解绑</div> -->
                            </div>
                            <div :id="'companyData-'+vo.id" style="display:none;">
                                <div class="info-line grey">
                                    <div class="info-title">联系人<i></i></div>
                                    <input type="text" :value="vo.linkman" readonly />
                                </div>
                                <div class="info-line grey">
                                    <div class="info-title">手机<i></i></div>
                                    <input type="number" :value="vo.contact" readonly />
                                </div>
                                <div class="info-line grey">
                                    <div class="info-title">法人代表<i></i></div>
                                    <input type="text" :value="vo.corporation" readonly />
                                </div>
                                <div class="info-line grey">
                                    <div class="info-title">身份证<i></i></div>
                                    <input type="number" :value="vo.corporate_idcard" readonly />
                                </div>
                                <div class="info-line grey">
                                    <div class="info-title">开户银行<i></i></div>
                                    <input type="text" name="" :value="vo.bank" readonly />
                                </div>
                                <div class="info-line grey">
                                    <div class="info-title">银行账号<i></i></div>
                                    <input type="number" name="" :value="vo.bank_account" readonly />
                                </div>
                                <div class="info-line ">
                                    <div class="info-title">注册地址<i></i></div>
                                    <div class="info-con">
                                        <p class="grey">{{vo.reg_region}} {{vo.reg_address}}</p>
                                    </div>
                                </div>
                                <div class="info-line grey">
                                    <div class="info-title">机构代码<i></i></div>
                                    <input type="number" name="" :value="vo.org_code" readonly />
                                </div>
                                <div class="info-line grey">
                                    <div class="info-title">邮箱<i></i></div>
                                    <input type="text" name="" :value="vo.email" readonly />
                                </div>
                                <div class="info-line">
                                    <div class="info-title">联系地址<i></i></div>
                                    <div class="info-con">
                                        <p class="grey">{{vo.region}} {{vo.address}}</p>
                                    </div>
                                </div>
                            <!--<div id="informations1">
                                    <volist name="customer.information" id="vo">
                                        <div class="info-line">
                                            <div class="info-title">{$vo.title}<i></i></div>
                                            <input type="text" style="width: 80%" data-id="{$vo.id}" data-title="{$vo.title}" value="{$vo.value}" />
                                            <div class="delete-div">
                                                <span>删除</span>
                                            </div>
                                        </div>
                                    </volist>
                                </div>
                                <volist name="vo.information" id="vo1">
                                    <div class="info-line grey">
                                        <div class="info-title" style="color: grey">{$vo1.title}<i></i></div>
                                        <div class="info-con " style="color: grey">{$vo1.value}</div>
                                    </div>
                                </volist> -->
                            </div>
                            <div class="info-line grey" style="box-shadow: 0 1px 0 #eeeeee;">
                                <div class="info-title">人员类型<i></i></div>
                                <div class="info-con">
                                    <p class="grey"  v-if="vo.leader_id == '{$result.id}'" >管理员</p>
                                    <p class="grey" v-else>员工</p>
                                </div>
                            </div>
                        </div>
                    </template>
                    <!-- <div class="info-line">
                        <notempty name="result.mobile" >
                            <div class="relieve" onclick="bindCom(this)">+绑定新公司</div>
                        </notempty>
                    </div> -->
                </div>
            </eq>
            <!--  <button type="button" class="mui-btn mui-btn-primary mui-btn-outlined" style="width: 49%" onclick="javascript:window.history.back(-1);">取消</button> -->
            <button type="button" class="mui-btn mui-btn-primary mui-btn-outlined" style="width: 100%;height: 0.65rem;background-color: #007aff;color: #fff;" id="save-edited">保存</button>
            <!--<button class="save-edited mt30 bg-368bfe" style="width: 40%">保存</button>-->
        </form>
    </section>
    <div class="wrap-modal" style="display: none">
        <div class="modal-tag-select modal" style="width:95%">
            <div class="modal-content">
                <div style="overflow-x:hidden;">
                <div style="overflow-y:auto;width:107%;max-height:7rem">
                <div class="tag-checkbox" id="set-tag-wrap" style="display:flex;flex-wrap:wrap;">
                    <template v-for="(item,index) in tag_list">
                        <div style="width:30%;height:35px;display:flex;" >
                                <input v-if="item.is_checked == 1" type="checkbox" :value="item.id" name="tag_id" checked>
                                <input v-else type="checkbox" :value="item.id" name="tag_id" >
                            <div style="align-self:center;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;width: 100px">
                                {{item.value}}
                            </div>
                        </div>
                    </template>
                </div>
                </div>
                </div>
                <!-- <div class="flex-start mb15" style="margin-left:10px;">
                    <div class="wd25 tr">添加标签：</div>
                    <div class="flex-1 flex-start">
                        <div class="company-selected wd70">
                            <div>请选择标签</div>
                            <div class="select-icon1" onclick="tagList(this)"></div>
                        </div>
                       <div onclick="newTag()" class="new-group-tag blue-4591fe">添加新标签</div>
                    </div>
                </div> -->
                <div id="newTag" class="flex-direction-start mb15" style="margin-left:10px;">
                    <input id="newTagName" style="width: 65%;border: 1px solid #e9e9e9;" type="text" placeholder="请输入新标签名称" onkeyup="this.value=this.value.replace(/^ +| +$/g,'')" />
                    <button onclick="addTag()" class="confirm-btn ml10 blue-4591fe" style="width: 30%">+&nbsp;添加新标签</button>
                    <!-- <button onclick="addTag()" class="confirm-btn ml10 blue-4591fe">确定</button> -->
                    <!-- <button class="confirm-btn new-group-tag-close red-e91835">取消</button> -->
                </div>
                <div class="flex-1 tag-chosen">
                </div>
            </div>
            <div class="modal-btn">
                <button class="blue" id="popup-complete">确定</button>
                <button id="popup-close" class="popup-close">取消</button>
            </div>
        </div>
    </div>
    <script src="{$Think.const.JS_URL}jquery.min.js"></script>
    <include file="UserSupervise:foot_access_file" />
    <script src="/{$Think.MODULE_PATH}Public/vue/vue.min.js"></script>
    <script src="/{$Think.APP_PATH}Public/mui/js/mui.picker.js"></script>
    <script src="/{$Think.APP_PATH}Public/mui/js/mui.poppicker.js"></script>
    <script type="text/javascript">
    $(function() {
        if ('{$result.user_type}' == 2) {
            $("#userType").html("员工");
        }
        if ('{$result.user_type}' == 4) {
            $("#userType").html("成交客户");
        }
        if ('{$result.user_type}' == 5) {
            $("#userType").html("意向客户");
        }
    })
    mui.init();
    var service_manPick = new mui.PopPicker();
    service_manPick.setData({$service_man_list});

    function service_manList(e) {
        service_manPick.show(function(item) { //弹出列表并在里面写业务代码
            var itemCallback = service_manPick.getSelectedItems();
            $(e).prev("div").html(itemCallback[0].text);
            $(e).next("input").val(itemCallback[0].value);
        });
    }

    var typePick = new mui.PopPicker();
    typePick.setData([{ value: '2', text: '员工' }, { value: '4', text: '成交客户' }, { value: '5', text: '意向客户' }]);

    function typeList(e) {
        typePick.show(function(item) { //弹出列表并在里面写业务代码
            var itemCallback = typePick.getSelectedItems();
            $(e).prev("div").html(itemCallback[0].text);
            $(e).next("input").val(itemCallback[0].value);
        });
    }

    var groupPick = new mui.PopPicker();
    groupPick.setData({$group_list});
    $("#group_name").data("group_list", '{$group_list}');

    function groupList(e) {
        groupPick.show(function(item) {
            var itemCallback = groupPick.getSelectedItems();
            $(e).prev("div").html(itemCallback[0].text);
            $(e).next("input").val(itemCallback[0].value);
        });
    }

    /* var service_leaderPick = new mui.PopPicker();
    service_leaderPick.setData({$service_leader_list}
    );

    function service_leaderList(e) {
        customerPick.show(function(item) { //弹出列表并在里面写业务代码
            var itemCallback = customerPick.getSelectedItems();
            $(e).prev("div").html(itemCallback[0].text);
            $(e).next("input").val(itemCallback[0].value);
        });
    }*/


    //点击删除
    $('.tags-view').on('click', 'span > b', function() {
        var obj = $(this);
        var text = obj.attr('bind-text');
        var btnArray = ['取消', '确定'];
        var message = '确认移除该标签"' + text + '"?';
        var user_id = '{$result.id}';
        var tag = obj.attr('bind-id');
        mui.confirm(message, '', btnArray, function(e) {
            if (e.index == 1) {
                $.post("/ComPotential/removeTag", { tag: tag, user_id: user_id }, function(result) {
                    if (result.code == 0) {
                        layer.msg('移除标签成功');
                        var bindId = obj.attr('bind-id');
                        $('.tags-div > input[value=' + bindId + ']').remove();
                        obj.parent('span').remove();
                        var num = 0;
                        $('.tags-item').find("lable").each(function() {
                            num = num + 1;
                        });
                        if (num == 0) {
                            $('.tag-none').show();
                        }
                    } else {
                        layer.msg('添加失败');
                    }
                }, "json");
            }
        })
    })

    function setTags() {
        //禁止滑动
        $('body').css({'overflow-y':'hidden','height':'100%','position':'fixed'});
        $("#newTagName").val("");
        setTag.tag_list = [];
        $.post("/ComPotential/getUserTag/id/{$result.id}", function(result) {
            setTag.tag_list = result.tag_list;
            $('.wrap-modal').show();
        }, "json");
    }
    $('.popup-close').on('click', function() {
        $('body').css({'overflow-y':'initial','height':'','position':''});
        $(this).parents('.wrap-modal').hide();
    })
    $(function() {
        var tags = '{$tags_lists}' || '';
        if ($.trim(tags) != '') {
            setLocalStorage($.trim(tags), 'tags');
        }
    })
    //设置localStorage
    function setLocalStorage(data, itemValue) {
        data = ($.isArray(data) || $.type(data) == 'object') ? JSON.stringify(data) : data;
        localStorage.setItem(itemValue, data);
    }

    function getLocalStorage(itemValue) {
        var value = localStorage.getItem(itemValue);
        return $.parseJSON(value);
    }
    </script>
    <script>
    $('#informations').on('click', '.info-line > .delete-div > span', function() {
        //删除该项
        var obj = $(this);
        var title = $(this).parent('.delete-div').prev('input').data('title');
        var btnArray = ['取消', '删除'];
        var message = '确认删除该自定义类型"' + title + '"吗?';

        mui.confirm(message, '删除自定义类型', btnArray, function(e) {
            if (e.index == 1) {
                obj.parent('.delete-div').parent('.info-line').remove();
                var delId = obj.parent('.delete-div').parent('.info-line').children(":text").data("id");
                var ids = $("#delInfo").val();
                if (delId != "") {
                    if (ids != "") {
                        $("#delInfo").val(ids + ";" + delId);
                    } else {
                        $("#delInfo").val(delId);
                    }
                }
            }
        })
    })

    var setTag = new Vue({
        el: "#set-tag-wrap",
        data: {
            tag_list:[]
        }
    });
    var customerTag = new Vue({
        el: "#customerTag",
        data: {
            tag_list:[]
        }
    });

    function queryUserTag() {
        $.post("/ComPotential/getUserTag/id/{$result.id}", function(result) {
            customerTag.tag_list = result.user_tag;
        }, "json");
    }
    queryUserTag();
    $('#save-edited').on('click', function() {
        var email = $('input[name*=email]').val();
        var fax = $('input[name*=fax_number]').val();
        var telephone = $('input[name*=telephone]').val();
        if (($.trim(email) != '')) {
            var reg = new RegExp("^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$"); //正则表达式
            if (!reg.test($.trim(email))) {
                layer.msg('请输入正确的邮箱地址!')
                return false;
            }
        }
        /*if (($.trim(fax) != '')) {
            var reg = new RegExp("/^(\\d{3,4}-)?\\d{7,8}$/"); //正则表达式
            if (!reg.test($.trim(email))) {
                layer.msg('请输入正确的传真号码!')
                return false;
            }
        }
        if (($.trim(telephone) != '')) {
            var reg_mobile = /^[1][3,4,5,7,8][0-9]{9}$/; //正则表达式
            var reg_telephone = /^0\d{2,3}-?\d{7,8}$/; //正则表达式
            if (!reg_mobile.test($.trim(telephone)) && !reg_telephone.test($.trim(telephone))) {
                layer.msg('请输入正确的电话!')
                return false;
            }
        }*/
        var formValue = $('#customerForm').serializeArray();
        //获取informations
        var informations = $('#informations').find('.info-line > input');
        if (informations.length > 0) {
            informations.map(function() {
                if ($(this).data('id') > 0) {
                    formValue.push({ 'name': 'information[old][]', 'value': $(this).data('id') + '||' + $(this).data('title') + '||' + $(this).val() });
                } else {
                    formValue.push({ 'name': 'information[new][]', 'value': $(this).data('title') + '||' + $(this).val() });
                }
            });
        }
        $.post('__MODULE__/ComPotential/save', formValue, function(data) {
            layer.msg(data.message);
            // var id = $('input[name=id]').val();
            setTimeout(function() {
                window.location.href = '/ComPotential/index.html';
            }, 1000)
        }, 'JSON')
    })
    //添加新分组
    $('#new-group-btn').on('click', function() {
        var btnArray = ['取消', '确定'];
        mui.prompt('增加新的分组', '分组名称', "新分组", btnArray, function(e) {
            if (e.index == 1) {
                if ($.trim(e.value) == '') {
                    layer.msg('增加新的分组名称不能为空');
                    return false;
                }
                if ($.trim(e.value).length > 5) {
                    layer.msg('分组名称不能大于5个字');
                    return false;
                }
                var groups = JSON.parse($("#group_name").data("group_list"));
                if (groups.length > 0) {
                    for (var i = 0; i < groups.length; i++) {
                        if ($.trim(e.value) == groups[i].text) {
                            layer.msg('已存在相同的分组名称!!');
                            return false;
                        }
                    }
                }
                $.ajax({
                    url: '__MODULE__/UserSupervise/createCustomerGroup.html',
                    type: 'POST',
                    dataType: "json",
                    data: { value: $.trim(e.value) },
                    success: function(data) {
                        if (data.error == 0) {
                            var json = { "value": data.id, "text": e.value };
                            var json1 = JSON.parse($("#group_name").data("group_list"));
                            json1.unshift(json);
                            $("#group_name").data("group_list", JSON.stringify(json1));;
                            groupPick.setData(json1);
                            $("#group_name").html(e.value);
                            $("#group_id").val(data.id);
                            layer.msg(data.message);
                        } else {
                            layer.msg(data.message);
                        }
                    }
                });
            } else {
                layer.msg("已取消增加分组");
            }
        });
    })
    //添加自定义类型
    $('.customize').on('click', function() {
        var btnArray = ['取消', '确定'];
        mui.prompt('新增自定义类型', '自定义类型标题', "自定义类型", btnArray, function(e) {
            if (e.index == 1) {
                if ($.trim(e.value) == '') {
                    layer.msg('自定义类型名称不能为空');
                    return false;
                }
                if ($.trim(e.value).length > 5) {
                    layer.msg('自定义类型名称不能大于五个字');
                    return false;
                }
                //判断是否有重复title
                var informations = $('#informations').find('.info-line > input');
                if (informations.length > 0) {
                    var isAppend = true;
                    var titles = informations.map(function() {
                        return $(this).data('title');
                    }).get();
                    for (var i = 0; i < titles.length; i++) {
                        if ($.trim(titles[i]) == $.trim(e.value)) {
                            layer.msg('已存在相同的自定义类型!!');
                            isAppend = false;
                            return false;
                        }
                    }
                    if (!isAppend) {
                        return false;
                    }
                }
                $.ajax({
                    url: '__MODULE__/UserSupervise/hasInformationTitle.html',
                    type: 'POST',
                    dataType: "json",
                    data: { title: $.trim(e.value) },
                    success: function(data) {
                        if (data.error == 0) {
                            var single = {
                                'title': $.trim(e.value),
                            }
                            var html = parseTemplate('.template-1', single);
                            $('#informations').append(html);
                            if ($.trim(e.value).length > 4) {
                                $(".template-1 > .info-title").last().css('font-size', '12px');
                            }
                        } else {
                            layer.msg(data.message);
                        }
                    }
                });
            } else {
                layer.msg("已取消添加自定义类型");
            }
        });
    })
    </script>
    <script type="text/javascript">
    (function(mui, document) {
        mui.init();
        mui.ready(function() {
            //              var templatePicker = new mui.PopPicker({
            //                  layer: 1
            //              });
            //              var templateData = $.parseJSON('{$groups_lists}');
            //              var id = $('input[name*=group_id]').val();
            //              if(templateData){
            //                  templatePicker.setData(templateData);
            //                  if (id > 0) {
            //                      templatePicker.pickers[0].setSelectedValue(id);
            //                  }
            //                  var showTemplatePickerButton = document.getElementById('showGroupPicker');
            //                  var templateResult = document.getElementById('showGroupValuePicker');
            //                  templateResult.innerText = templatePicker.pickers[0].getSelectedText();
            //                  showTemplatePickerButton.addEventListener('tap', function (event) {
            //                      templatePicker.show(function (items) {
            //                          templateResult.innerText = (items[0] || {}).text;
            //                          $('input[name*=group_id]').val(items[0].value);
            //                      });
            //                  }, false);
            //              }

            var cityPicker3 = new mui.PopPicker({
                layer: 3
            });
            var cityData3 = $.parseJSON('{$region}');
            if (cityData3) {
                cityPicker3.setData(cityData3);
                var distrust = $('#distrust').val();
                var city = $('#city').val();
                var province = $('#province').val();
                cityPicker3.pickers[0].setSelectedValue(province);
                setTimeout(function() {
                    cityPicker3.pickers[1].setSelectedValue(city);
                    setTimeout(function() {
                        cityPicker3.pickers[2].setSelectedValue(distrust);
                    }, 200)
                }, 200)
                var showCityPickerButton = document.getElementById('showCityPicker');
                var cityResult3 = document.getElementById('showCity');
                showCityPickerButton.addEventListener('tap', function(event) {
                    cityPicker3.show(function(items) {
                        if (items[0].value == items[1].value) {
                            cityResult3.innerText = (items[0] || {}).text;
                            $('#showCityPicker').attr('value', items[0].value);
                        } else if (items[1].value == items[2].value || typeof(items[2].value) == 'undefined') {
                            cityResult3.innerText = (items[0] || {}).text + " " + (items[1] || {}).text;
                            $('#showCityPicker').attr('value', items[1].value);
                        } else {
                            cityResult3.innerText = (items[0] || {}).text + " " + (items[1] || {}).text + " " + (items[2] || {}).text;
                            $('#showCityPicker').attr('value', items[2].value);
                        }
                        $("#province").val(items[0].value);
                        $("#city").val(items[1].value);
                        $("#district").val(items[2].value);
                    });
                }, false);
            }

            var cityPicker4 = new mui.PopPicker({
                layer: 3
            });
            var cityData4 = $.parseJSON('{$region}');
            if (cityData4) {
                cityPicker4.setData(cityData4);
                var distrust1 = $('#distrust1').val();
                var city1 = $('#city1').val();
                var province1 = $('#province1').val();
                cityPicker4.pickers[0].setSelectedValue(province1);
                setTimeout(function() {
                    cityPicker4.pickers[1].setSelectedValue(city1);
                    setTimeout(function() {
                        cityPicker4.pickers[2].setSelectedValue(distrust1);
                    }, 200)
                }, 200)
                // var showCityPickerButton1 = document.getElementById('showCityPicker1');
                // var cityResult4 = document.getElementById('showCity1');
                // showCityPickerButton1.addEventListener('tap', function (event) {
                //     cityPicker4.show(function (items) {
                //         if(items[0].value == items[1].value) {
                //             cityResult4.innerText = (items[0] || {}).text;
                //             $('#showCityPicker1').attr('value', items[0].value);
                //         } else if(items[1].value == items[2].value || typeof(items[2].value) == 'undefined') {
                //             cityResult4.innerText = (items[0] || {}).text + " " + (items[1] || {}).text;
                //             $('#showCityPicker1').attr('value', items[1].value);
                //         } else {
                //             cityResult4.innerText = (items[0] || {}).text + " " + (items[1] || {}).text + " " + (items[2] || {}).text;
                //             $('#showCityPicker1').attr('value', items[2].value);
                //         }
                //         $("#province1").val(items[0].value);
                //         $("#city1").val(items[1].value);
                //         $("#district1").val(items[2].value);
                //     });
                // }, false);
            }
        });
    })(mui, document);

    function showCompanyData(obj) {
        var id = obj.getAttribute("data-companyid");
        if ($(obj).attr("flag") == 1) {
            $(obj).css('transform', 'rotate(180deg)');
            $(obj).attr("flag", 2);
        } else {
            $(obj).css('transform', 'rotate(0)');
            $(obj).attr("flag", 1);
        }
        $("#companyData-" + id).toggle();
    }

    function notifyUser() {
        var user_ids = [];
        $("input[name='user_id']").each(function() {
            user_ids.push("{$id}");
        });

        var btnArray = ['否', '是'];
        mui.confirm('我们将通过消息通知客户绑定手机,现在要发送通知吗？', ' ', btnArray, function(e) {
            if (e.index == 1) {
                $.post("/ComPotential/notifyUser", { user_ids: user_ids }, function(result) {
                    layer.msg(result.message);
                    if (result.code == 0) {
                        setTimeout(function(result) {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        }, 1500);
                    }
                }, "json");
            }
        })
    }


    function bindCom(e) {
        var url = '__MODULE__/ComPotential/bindCompany/id/{$result.id}';
        parent.$(".layui-layer-title").html("绑定公司-选择公司");
        layer.open({
            type: 2,
            //title: '关联公司-选择公司',
            title: '',
            shadeClose: true,
            shade: 0.8,
            area: ['100%', '100%'],
            content: url, //iframe的url
            closeBtn: 0,
            success: function(layero, index) {},
            end: function() {
                parent.$(".layui-layer-title").html("关联公司");
            }
        });
    }
    var vue = new Vue({
        el: "#companyData-all",
        data: {
            companyList: []
        },
        methods: {
        }
    });

    function queryCompanyData() {
        $.post("/ComPotential/getCompanyData/id/{$result.id}", function(result) {
            vue.companyList = result;
        }, "json");
    }
    queryCompanyData();
    
    function unbindCom(obj) {
        var btnArray = ['否', '是'];
        mui.confirm('确认要解绑该公司吗？', ' ', btnArray, function(e) {
            if (e.index == 1) {
                var companyId = obj.getAttribute("data-companyid");
                var id = '{$result.id}';
                $.post('/ComPotential/unbindCompany', {id:id,company_id: companyId }, function(data) {
                    layer.msg(data.message);
                    //解绑后删除所在公司中已选择的这个公司
                    if (data.code == 0) {
                        queryCompanyData();
                    }
                }, 'JSON')
            }
        })
    }
    // function unbindCom(obj) {
    //     var btnArray = ['否', '是'];
    //     mui.confirm('确认要解绑该公司吗？', '解除匹配', btnArray, function(e) {
    //         if (e.index == 1) {
    //             var delidInput = $("#unbindCom").val();
    //             var comId = obj.getAttribute("data-companyid");
    //             var delId = delidInput == "" ? comId : delidInput + "," + comId;
    //             $("#unbindCom").val(delId);
    //             var div = "#company-" + comId;

    //             $(div).remove();
    //             var comName = obj.getAttribute("data-companyname");
    //             layer.msg('保存成功后将解除与 ' + comName + ' 的匹配！');
    //         }
    //     })
    // }

    //选择业务负责人
    $('#select_service_man').on('click', function() {
        var url = '__MODULE__/ComPotential/select_service_man';
        layer.open({
            type: 2,
            title: '选择业务负责人',
            shadeClose: true,
            shade: 0.8,
            area: ['100%', '100%'],
            content: url, //iframe的url
        });
    })

    function getService_man(value, text) {
        $(".service_man").text(text);
        $("#service_man").val(value);
    }
    $('#select_service_leader').on('click', function() {
        var url = '__MODULE__/ComPotential/select_service_leader';
        layer.open({
            type: 2,
            title: '选择业务可见人',
            shadeClose: true,
            shade: 0.8,
            area: ['100%', '100%'],
            content: url, //iframe的url
            success: function(layero, index) {
                // var body = layer.getChildFrame('body', index);
                // body.contents().find("#name").val('"'+name+'"'+type);
            },
            end: function() {

                // if($('#handle_status').val() == 1) {
                //     location.reload();
                // }
            }
        });
    })

    function getService_leader(value, text) {
        $(".service_leader").text(text);
        $("#service_leader").val(value);
    }

    var tagPick = new mui.PopPicker();
    tagPick.setData({$result.json_tags});

    function tagList(e) {
        tagPick.show(function(item) {
            var itemCallback = tagPick.getSelectedItems();
            if ($("span[value='" + itemCallback[0].value + "']").length == 0 && $("b[bind-id='" + itemCallback[0].value + "']").length == 0) {
                var html = $(".tag-chosen").html();
                var str = "";
                str = "<span class='tag-group-tag_id' value='" + itemCallback[0].value + "' onclick='removeTag(this)' >" +
                    itemCallback[0].text + "</span>";
                $(".tag-chosen").html(html + str);
            } else {
                layer.msg('该标签已添加');
            }
        });
    }

    function addTag() {
        var name = $("#newTagName").val();
        if (name == '') {
            layer.msg('必须输入标签名称');
            return false;
        }
        $.post("/ComPotential/addTag", {value:name}, function(result) {
            if (result.code == 0) {
                layer.msg('添加成功');
                var tag_ids = [];
                $("input[name='tag_id']:checkbox:checked").each(function() {
                    tag_ids.push($(this).val());
                });
                tag_ids.push(result.last_id);
                $.post("/ComPotential/setUserTag/id/{$result.id}", { tag_ids: tag_ids}, function(result) {
                     queryUserTag();
                    setTag.tag_list = [];
                    $.post("/ComPotential/getUserTag/id/{$result.id}", function(result) {
                        setTag.tag_list = result.tag_list;
                    }, "json");
                }, "json");
                $("#newTagName").val("");
            } else {
                layer.msg(result.message);
            }
        }, "json");
    }

    function newTag() {
        $("#newTag").show();
    }
    function removeTag(e) {
        $(e).remove();
    }

    function toTelephone(obj){
        var mobile = $(obj).data('mobile');
        if (!(/^1[3|4|5|7|8][0-9]\d{4,8}$/.test(mobile))){
            layer.msg('该客户没有绑定手机号码!')
        } else {
            window.location.href = 'tel:'+mobile;
        }
    }
    
    $('.new-group-tag-close').on('click', function() {
        $(this).parent().hide();
    })

    $('#popup-complete').on('click', function() {
        // var group_id = $("input[name='group_id']").val();
        // console.info(group_id);
        var tag_ids = [];

        $("input[name='tag_id']:checkbox:checked").each(function() {
            tag_ids.push($(this).val());
        });
        $.post("/ComPotential/setUserTag/id/{$result.id}", { tag_ids: tag_ids}, function(result) {
            if (result.code == 0) {
                layer.msg('添加成功');
                queryUserTag();
                // $(".tags-item").remove();
                // var html = $(".tags-item").html();
                // var html = "";
                // // alert(html);
                // var str = "";
                // $("span.tag-group-tag_id").each(function() {
                //     str = '<span class="lable" style="margin-right:10px;">' + $(this).text() + '<b bind-id="' + $(this).attr("value") + '" bind-text="' + $(this).text() + '">✘</b> </span>';
                //     html = html + str;
                // });

                // $(".tags-item").html(html);
                // $("#tag-none").hide();
                // $("#add-tag").before(html);

                // $(".tag-chosen").html("");
                //解除禁止滑动
                $('body').css({'overflow-y':'initial','height':'','position':''});
                $('.wrap-modal').hide();
                // window.location.href = '/ComFan/index.html';
            } else {
                layer.msg('添加失败');
            }
        }, "json");

    })
    </script>
</body>

</html>