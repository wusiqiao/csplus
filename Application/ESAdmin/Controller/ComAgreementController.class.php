<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2018/12/18
 * Time: 10:08
 */

namespace ESAdmin\Controller;
use Common\Lib\Controller\DataController;

class ComAgreementController extends DataController
{
    public function _parsefilter(&$filter){
        parent::_parsefilter($filter); // TODO: Change the autogenerated stub
        $company_id = $this->_user_session->currBranchId;
        /*$user_id = $this->_user_session->userId;
        $result = M("SysBranch")->where("id = $company_id")->field("customer_leader_id")->find();
        if($result['leader_id'] != $user_id){
            $filter['a.customer_leader_id'] = $user_id;
        }*/
        $filter['a.company_id'] = $company_id;
        if($filter['a.state'] == ""){
            $filter["a.state"] = array("neq", "0");
        }
    }

    public function nameListAction(){
        $name = I("q");
        $condition['name'] = array("like","%".$name."%");
        $condition['company_id'] = $this->_user_session->currBranchId;
        $condition['state'] = array("neq",0);
        $result = M("WrkAgreement")->where($condition)->field("name as id, name")->select();
        $this->ajaxReturn($result);
    }

    public function _before_list(&$list){
        M("WrkReceivables")->where("contract_id = 442")->setField("new_message",1);
        foreach($list as $k=>$v){
            $list[$k]['customer_branch_name'] = M("SysBranch")->where("id = ".$v['company_id'])->getField("name");
            $list[$k]['invoice_type'] = M("WrkAgreement")->where("id = ".$list[$k]['id'])->getField("invoice_type");
            //$list[$k]['is_show_invoice'] = M("WrkInvoicePlan")->where("agreement_id = ".$list[$k]['id'])->getField("is_sendWX");
            $list[$k]['is_show_invoice'] = (!empty($v['wip_creater_id']) && ($v['wip_is_sendwx'] == 1)) ? 1 : 0;
            $list[$k]['receivables_id'] = M("WrkReceivables")->where("contract_id = ".$v['id'])->getField("id");
            $list[$k]['new_invoice'] = $this->isNewInvoice($v['id']) == "" ? 0 :1;
            $list[$k]["wr"] = M("WrkReceivables")->where("contract_id = ".$v['id'])->find();
        }
    }

    public function isNewInvoice($id){
        $result = M("WrkInvoicePlan")->alias("a")->join("wrk_invoice_record as b on a.id = b.plan_id")
            ->where("a.agreement_id = $id and b.read = 0")->find();
        return $result;
    }

    public function _before_detail(&$data){
        $data['start_time'] = date("Y/m/d",$data['start_time']);
        $data['finish_time'] = date("Y/m/d",$data['finish_time']);
    }

    public function invoiceAction(){
        if(IS_POST){
            $id = I("post.id");
            $result = M("WrkAgreement")->alias("a")->join("wrk_invoice_plan as b on a.id = b.agreement_id")
                ->where("a.id = $id")->field("b.amount_paid,a.agreement_money,b.state")->find();
            if($result['state'] == 0){
                if($result['agreement_money'] > $result['true_money']){
                    $this->ajaxReturn(array("code"=>1));
                }else{
                    $this->ajaxReturn(array("code"=>0,"message"=>"已开票金额已达到合同金额,无法继续申请发票！"));
                }
            }else{
                $this->ajaxReturn(array("code"=>0,"message"=>"合同已结束开票,无法继续申请发票！"));
            }

        }else{
            $agreement_id = I("get.agreement_id");
            $agreement = M("WrkAgreement")->where("id = $agreement_id")->field("id,name,agreement_sn,agreement_money,start_time,finish_time")->find();
            if($agreement['finish_time'] == ""){
                $agreement['time'] = date("Y/m/d",$agreement['start_time']) ." -- *";
            }else{
                $agreement['time'] = date("Y/m/d",$agreement['start_time']) . "--" . date("Y/m/d",$agreement['finish_time']);
            }
            $tmp = $this->isNewInvoice($agreement_id);
            if($tmp){
                M("WrkInvoiceRecord")->where("plan_id = ".$tmp['plan_id'])->setField("read",1);
            }
            $this->assign("agreement",$agreement);
            $this->display();
        }
    }

    public function invoiceApplyAction(){
        if(IS_POST){
            $agreement_id = I("post.id");
            $plan_day = strtotime(I("post.plan_day"));
            $plan_money = I("post.plan_money");
            if($plan_day == '' or $plan_money ==""){
                $this->ajaxReturn(array("error"=>1,"message"=>"请输入必填项！"));
            }
            $tmp = M("WrkAgreement")->alias("a")->join("wrk_invoice_plan as b on a.id = b.agreement_id")
                ->where("a.id = $agreement_id")->field("a.agreement_money,b.amount_paid,b.id as plan_id")->find();
            if(($tmp['agreement_money'] - $tmp['amount_paid']) < $plan_money){
                $this->ajaxReturn(array("error"=>1,"message"=>"已开金额与申请金额大于合同金额，无法申请"));
            }else{
                $data['plan_money'] = $plan_money;
                $data['notify_day'] = time();//申请日期
                $data['plan_day'] = $plan_day;
                $data['type'] = 1;//开票申请
                $data['create_time'] = time();
                $data['is_invoice'] = 1;
                $data['plan_id'] = $tmp['plan_id'];
                $data['branch_id'] = M("SysUser")->where("id = ".$this->_user_session->userId)->getField("branch_id");
                $data['agreement_id'] = $agreement_id;
                $result = M("WrkInvoicePlanDetail")->add($data);
                if($result !== false){
                    D("ComAgreement")->sendInvoiceApplyMessage($agreement_id,$plan_money);
                    $this->ajaxReturn(array("error"=>0,"message"=>"申请成功！"));
                }else{
                    $this->ajaxReturn(array("error"=>1,"message"=>"申请失败！"));
                }
            }
        }else{
            $id = I("get.id");
            $result = M("WrkAgreement")->where("id = $id")->find();
            $this->assign("model",$result);
            $this->display();
        }
    }

    public function getInvoiceRecordAction(){
        $id = I("post.id");
        $result = M("WrkInvoicePlan")->alias("a")
            ->join("wrk_invoice_record as b on a.id = b.plan_id")
            ->where("a.agreement_id = $id")
            ->field("b.*,a.attach_group as wip_attach_group")
            ->order("invoice_day desc")->select();
        foreach ($result as $k=>$v) {
            $result[$k]['invoice_day'] = date("Y/m/d",$v['invoice_day']);
            $result[$k]['confirm_man'] = $v['confirm_man'] == "" ? "0":M("SysUser")->where("id = ".$v['confirm_man'])->getField("name");
            $result[$k]['state'] = $v['state'] == 1 ? "正常":"作废";
            $result[$k]['invoice_type'] = $v['invoice_type'] == 0 ? "普通发票":"增值税专用发票";
        }
        $this->ajaxReturn($result);
    }

    //确认签收发票
    function confirmInvoiceAction(){
        $id = I("post.id");
        $data['confirm_man'] = $this->_user_session->userId;
        $data['express_state'] = 1;
        $result = M("WrkInvoiceRecord")->where("id = $id")->save($data);
        if($result != false){
            $this->ajaxReturn(array("error"=>0,"message"=>"签收成功！"));
        }else{
            $this->ajaxReturn(array("error"=>1,"message"=>"签收失败！"));
        }
    }

}